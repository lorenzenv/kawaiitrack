<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Added a cute title! ♡ -->
    <title>✩ Kawaii Habit Tracker ✩</title>
    <!-- Added a cute Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Added Font Awesome for cute icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            /* --- Kawaii Color Palette --- */
            --primary: #ffafcc; /* Soft Pink */
            --primary-light: #ffc0db; /* Lighter Pink */
            --primary-dark: #ff9eb5; /* Darker Pink */
            --secondary: #a2d2ff; /* Baby Blue */
            --accent: #fcf6bd; /* Pale Yellow */
            --success: #b0f2c2; /* Mint Green */
            --success-dark: #87e0a6;
            --danger: #ffb3c1; /* Soft Red/Pink */
            --danger-dark: #ff9bad;
            --background: #fff0f5; /* Lavender Blush */
            --card: #ffffff;
            --text: #6d6875; /* Muted Purple/Gray */
            --text-light: #a39daa; /* Lighter Muted Purple */
            --border: #ffe5ec; /* Very Light Pink */
            --border-radius: 20px; /* Increased roundness */
            --shadow: 0 5px 15px -3px rgba(255, 175, 204, 0.2), 0 4px 6px -4px rgba(255, 175, 204, 0.15); /* Softer pink shadow */
            --kawaii-font: 'M PLUS Rounded 1c', sans-serif; /* Cute Font */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--kawaii-font); /* Apply cute font */
        }

        body {
            background-color: var(--background);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'%3E%3Cpath d='M14 0 L16.09 5.36 L21.88 5.36 L17.4 8.64 L19.5 14 L14 10.72 L8.5 14 L10.6 8.64 L6.12 5.36 L11.91 5.36 Z' fill='%23FFECF2' fill-opacity='0.5'/%3E%3C/svg%3E"); /* Subtle star pattern */
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
            transition: background-color 0.3s ease; /* Smooth transitions */
        }

        .container {
            max-width: 700px; /* Slightly smaller for cuter proportions */
            margin: 0 auto;
        }

        header {
            margin-bottom: 2.5rem;
            text-align: center;
            animation: fadeInDown 0.5s ease-out;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem; /* Slightly larger */
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7); /* Subtle text shadow */
        }
         h1::before {
            content: '✩ '; /* Star decoration */
            opacity: 0.8;
         }
          h1::after {
            content: ' ✩'; /* Star decoration */
            opacity: 0.8;
         }


        .date {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .card {
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem; /* More padding */
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            position: relative; /* For potential decorations */
            overflow: hidden; /* Ensure decorations don't overflow */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
             transform: translateY(-3px) scale(1.01); /* Subtle lift effect */
             box-shadow: 0 8px 20px -3px rgba(255, 175, 204, 0.25), 0 6px 10px -4px rgba(255, 175, 204, 0.2);
        }

        /* Small heart decoration on card */
        .card::before {
            content: '♡';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--primary-light);
            opacity: 0.5;
        }

        .form-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem; /* More space */
        }

        input[type="text"] {
            flex: 1;
            padding: 0.85rem 1.2rem; /* Slightly larger padding */
            border: 2px solid var(--border); /* Slightly thicker border */
            border-radius: var(--border-radius);
            font-size: 1rem;
            color: var(--text);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fffafa; /* Very light pinkish background */
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(255, 175, 204, 0.3); /* Pink glow on focus */
        }

        button {
            cursor: pointer;
            padding: 0.85rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 700; /* Bolder button text */
            transition: background-color 0.2s ease, transform 0.15s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.02); /* Bouncy hover effect */
        }
        button:active {
            transform: translateY(0px) scale(0.98); /* Press down effect */
        }

        .btn-small {
            padding: 0.5rem 0.8rem;
            font-size: 0.875rem;
            border-radius: 15px; /* Smaller buttons also rounded */
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .habit-list {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* More spacing */
        }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            background-color: white;
            border: 2px solid var(--border); /* Thicker border */
            border-radius: var(--border-radius);
            transition: all 0.25s ease-out;
            animation: popIn 0.4s ease-out forwards; /* Add animation */
            opacity: 0; /* Start hidden for animation */
            transform: scale(0.95);
        }
        /* Stagger animation */
        .habit-item:nth-child(1) { animation-delay: 0.05s; }
        .habit-item:nth-child(2) { animation-delay: 0.1s; }
        .habit-item:nth-child(3) { animation-delay: 0.15s; }
        /* Add more if needed */

        .habit-item:hover {
            transform: translateY(-3px) scale(1.01); /* Lift on hover */
            border-color: var(--primary-light);
            box-shadow: var(--shadow);
        }

        .habit-item.completed {
            border-left: 6px solid var(--success); /* Thicker success border */
            background-color: #f0fff5; /* Light green background */
        }

        /* --- Kawaii Checkbox --- */
        .habit-checkbox {
            margin-right: 1.2rem;
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-light); /* Pink border */
            border-radius: 8px; /* Rounded square */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
            position: relative;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .habit-checkbox::after {
            /* Using Font Awesome heart */
            font-family: "Font Awesome 6 Free";
            content: "\f004"; /* Heart icon */
            font-weight: 900;
            position: absolute;
            color: var(--success);
            font-size: 14px;
            transform: scale(0); /* Start hidden */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
        }

        .habit-item.completed .habit-checkbox {
            background-color: var(--success); /* Green background when checked */
            border-color: var(--success-dark);
            transform: rotate(10deg) scale(1.1); /* Tilt and grow when checked */
        }

        .habit-item.completed .habit-checkbox::after {
            transform: scale(1); /* Show heart */
            color: white; /* White heart on green background */
        }

        .habit-text {
            flex: 1;
            font-size: 1.05rem; /* Slightly larger text */
            font-weight: 500;
        }

        .habit-item.completed .habit-text {
            text-decoration: line-through;
            text-decoration-color: var(--primary); /* Pink strikethrough */
            text-decoration-thickness: 2px;
            color: var(--text-light);
            font-style: italic;
        }

        .habit-actions {
            display: flex;
            gap: 0.6rem;
            align-items: center; /* Align icons nicely */
        }
        /* Replace buttons with cute icons */
        .habit-actions button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem; /* Icon size */
            padding: 0.3rem;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
        }
        .habit-actions button:hover {
            color: var(--primary);
            background-color: #fff0f5; /* Light pink background on hover */
            transform: scale(1.1);
        }
        .habit-actions .delete-habit:hover {
            color: var(--danger-dark);
            background-color: #fff0f0; /* Light red background on hover */
        }


        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            background-color: #fffafa;
            margin-top: 1rem;
        }
        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .empty-state::before {
            content: '(づ ◕‿◕ )づ'; /* Cute emoticon */
            font-size: 2rem;
            display: block;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .streak-section {
            display: flex;
            justify-content: space-around; /* Space out more */
            margin-bottom: 2rem;
            gap: 1rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .streak-card {
            flex: 1;
            padding: 1.2rem;
            text-align: center;
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s ease-out;
            position: relative; /* For potential decorations */
            overflow: hidden;
        }
         .streak-card::after { /* Add a little star decoration */
             content: '✨';
             position: absolute;
             bottom: 5px;
             right: 10px;
             font-size: 1.2rem;
             opacity: 0.6;
             transform: rotate(-15deg);
         }

        .streak-card:hover {
            transform: translateY(-4px);
        }

        .streak-value {
            font-size: 2.5rem; /* Bigger numbers */
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--primary); /* Pink numbers */
            transition: color 0.3s ease; /* Animate color changes */
        }
        .streak-value:hover {
             color: var(--primary-dark);
        }

        .streak-label {
            color: var(--text-light);
            font-size: 0.9rem; /* Slightly larger label */
            font-weight: 500;
        }

        .stats-section {
            margin-top: 2.5rem;
            animation: fadeInUp 0.7s ease-out;
        }

        .stats-title {
            font-size: 1.5rem; /* Bigger title */
            margin-bottom: 1.5rem;
            color: var(--secondary); /* Blue title */
            text-align: center;
            font-weight: 700;
        }
        .stats-title::before { content: '🗓️ '; } /* Calendar emoji */

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.6rem; /* Slightly more gap */
            background-color: #fffafa; /* Light background for calendar area */
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff; /* White days */
            border-radius: 10px; /* Rounder days */
            font-size: 0.8rem;
            font-weight: 500;
            cursor: default;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day.has-completed {
            background-color: var(--success); /* Mint green */
            color: var(--text); /* Darker text for contrast */
            font-weight: 700;
            transform: scale(1.05); /* Pop effect */
            border-color: var(--success-dark);
        }
        /* Add a little star on completed days */
        .calendar-day.has-completed::after {
            content: '★';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.8);
        }


        .calendar-day.today {
            border: 2px solid var(--primary); /* Pink border for today */
            color: var(--primary);
            font-weight: 700;
        }
         .calendar-day:not(.has-completed):hover {
             background-color: #fff5f8; /* Very light pink hover */
             transform: scale(1.03);
         }

        /* --- Modal Styling --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 175, 204, 0.3); /* Pinkish overlay */
            backdrop-filter: blur(5px); /* Blur background */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card);
            padding: 2.5rem; /* More padding */
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px; /* Slightly smaller modal */
            transform: scale(0.95) translateY(-20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
            box-shadow: 0 10px 30px -5px rgba(255, 175, 204, 0.4); /* Stronger shadow */
             border: 2px solid var(--primary-light);
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px dashed var(--border); /* Dashed line separator */
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.6rem; /* Larger title */
            color: var(--primary);
            font-weight: 700;
        }
         .modal-title::before { content: '✏️ '; } /* Pencil emoji */

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            background-color: var(--text-light); /* Use text light color */
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--text);
        }

        /* --- Animations --- */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            80% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

         @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            h1 { font-size: 2rem; }
            .streak-section {
                flex-direction: column;
                gap: 1rem;
            }
            .streak-card { margin: 0; }
            .calendar { grid-template-columns: repeat(7, 1fr); gap: 0.4rem; padding: 0.8rem; } /* Keep 7 columns if possible */
             .calendar-day { font-size: 0.7rem; }
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.8rem; }
            .form-group { flex-direction: column; }
             input[type="text"] { font-size: 0.9rem;}
             button { font-size: 0.9rem; padding: 0.75rem 1.2rem;}
            .habit-item { padding: 0.8rem 1rem; flex-wrap: wrap; } /* Allow wrap on small screens */
            .habit-text { font-size: 0.95rem; margin-bottom: 0.5rem; /* Add space if actions wrap below */ width: 100%; order: 1; /* Ensure text is first */ }
            .habit-checkbox { margin-right: 0.8rem; order: 0;}
            .habit-actions { order: 2; margin-left: auto; /* Push actions to the right */ }
            .streak-value { font-size: 2rem; }
            .modal-content { padding: 1.5rem; }
            .modal-title { font-size: 1.4rem; }
            .calendar { gap: 0.3rem; padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>My Kawaii Habits</h1>
            <div class="date" id="current-date"></div>
        </header>

        <section class="streak-section">
            <div class="streak-card">
                <div class="streak-value" id="current-streak">0</div>
                <div class="streak-label">💖 Current Streak</div>
            </div>
            <div class="streak-card">
                <div class="streak-value" id="completion-rate">0%</div>
                <div class="streak-label">🌟 Completion Rate</div>
            </div>
            <div class="streak-card">
                <div class="streak-value" id="total-completed">0</div>
                <div class="streak-label">🎉 Total Completed</div>
            </div>
        </section>

        <div class="card">
            <div class="form-group">
                <input type="text" id="habit-input" placeholder="Add a cute new habit! ✨" autocomplete="off">
                <button id="add-habit-btn"><i class="fa-solid fa-plus"></i> Add!</button>
            </div>

            <div class="habit-list" id="habit-list">
                <!-- Habits will be added here -->
            </div>

            <div class="empty-state" id="empty-state" style="display: none;">
                 <p>No habits yet! Let's add something fun to track today! (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧</p>
            </div>
        </div>

        <div class="card stats-section">
            <h2 class="stats-title">Your Lovely Progress (Last 28 Days)</h2>
            <div class="calendar" id="calendar">
                <!-- Calendar days will be added here -->
            </div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Habit</h2>
                <button class="modal-close" id="close-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="edit-habit-input" placeholder="New habit name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-edit"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button id="save-edit"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements (same as before, plus icons maybe)
        const habitInput = document.getElementById('habit-input');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const habitList = document.getElementById('habit-list');
        const emptyState = document.getElementById('empty-state');
        const currentDateElement = document.getElementById('current-date');
        const editModal = document.getElementById('edit-modal');
        const editHabitInput = document.getElementById('edit-habit-input');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const closeModalBtn = document.getElementById('close-modal');
        const currentStreakElement = document.getElementById('current-streak');
        const completionRateElement = document.getElementById('completion-rate');
        const totalCompletedElement = document.getElementById('total-completed');
        const calendarElement = document.getElementById('calendar');

        // State (same as before)
        let habits = JSON.parse(localStorage.getItem('habits')) || [];
        let habitHistory = JSON.parse(localStorage.getItem('habitHistory')) || {};
        let currentEditId = null;

        // Format current date (same as before)
        function formatDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            currentDateElement.textContent = today.toLocaleDateString('en-US', options);
            return today.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

        const today = formatDate();

        // Initialize history for today if needed (same as before)
        if (!habitHistory[today]) {
            habitHistory[today] = { completed: [] };
            saveHistory();
        }

        // Save habits to localStorage (same as before)
        function saveHabits() {
            localStorage.setItem('habits', JSON.stringify(habits));
            renderHabits();
            updateStats();
        }

        // Save history to localStorage (same as before)
        function saveHistory() {
            localStorage.setItem('habitHistory', JSON.stringify(habitHistory));
            updateStats();
            renderCalendar(); // Re-render calendar on history change
        }

        // Render habits (Updated with Kawaii elements)
        function renderHabits() {
            if (habits.length === 0) {
                emptyState.style.display = 'block';
                habitList.innerHTML = '';
                updateStats(); // Update stats even when empty
                return;
            }

            emptyState.style.display = 'none';
            // Store current scroll position
            const scrollPosition = habitList.scrollTop;

            habitList.innerHTML = ''; // Clear list

            habits.forEach((habit, index) => {
                const isCompleted = habitHistory[today] &&
                                    habitHistory[today].completed &&
                                    habitHistory[today].completed.includes(habit.id);

                const habitElement = document.createElement('div');
                habitElement.className = `habit-item ${isCompleted ? 'completed' : ''}`;
                // Delay animation for existing items for a smoother load feel, instant for new ones
                habitElement.style.animationDelay = `${index * 0.05}s`;

                // Use Font Awesome icons for actions
                habitElement.innerHTML = `
                    <div class="habit-checkbox" data-id="${habit.id}" role="checkbox" aria-checked="${isCompleted}"></div>
                    <div class="habit-text">${habit.text}</div>
                    <div class="habit-actions">
                        <button class="btn-small edit-habit" data-id="${habit.id}" title="Edit Habit"><i class="fa-solid fa-pencil"></i></button>
                        <button class="btn-small btn-danger delete-habit" data-id="${habit.id}" title="Delete Habit"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                habitList.appendChild(habitElement);
            });

            // Restore scroll position
            habitList.scrollTop = scrollPosition;


            // Add event listeners (same logic, applied to new structure)
            document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', toggleHabit);
            });

            document.querySelectorAll('.edit-habit').forEach(button => {
                button.addEventListener('click', showEditModal);
            });

            document.querySelectorAll('.delete-habit').forEach(button => {
                button.addEventListener('click', deleteHabit);
            });
             updateStats(); // Update stats after rendering
        }

        // Add new habit (Added animation trigger)
        function addHabit() {
            const text = habitInput.value.trim();
            if (text === '') return;

            const newHabit = {
                id: Date.now().toString(),
                text,
                createdAt: new Date().toISOString()
            };

            habits.push(newHabit);
            saveHabits(); // This calls renderHabits which now includes animation
            habitInput.value = '';
        }

        // Toggle habit completion (same logic)
        function toggleHabit(e) {
            const habitId = e.target.getAttribute('data-id');

            if (!habitHistory[today]) {
                habitHistory[today] = { completed: [] };
            }

            // Ensure completed array exists
             habitHistory[today].completed = habitHistory[today].completed || [];

            const completedIndex = habitHistory[today].completed.indexOf(habitId);

            if (completedIndex === -1) {
                habitHistory[today].completed.push(habitId);
            } else {
                habitHistory[today].completed.splice(completedIndex, 1);
            }

            saveHistory();
            renderHabits(); // Re-render to update visual state
        }

        // Delete habit (Added confirmation)
        function deleteHabit(e) {
            // Use closest to get the button even if icon is clicked
            const button = e.target.closest('.delete-habit');
            if (!button) return;

            const habitId = button.getAttribute('data-id');
            const habitText = habits.find(h => h.id === habitId)?.text || 'this habit';

            // Cute confirmation!
            if (confirm(`Are you sure you want to delete "${habitText}"? (｡•́︿•̀｡)`)) {
                habits = habits.filter(habit => habit.id !== habitId);

                // Also remove from history
                Object.keys(habitHistory).forEach(date => {
                     if (habitHistory[date] && habitHistory[date].completed) {
                        habitHistory[date].completed = habitHistory[date].completed.filter(id => id !== habitId);
                    }
                });

                saveHabits();
                saveHistory();
            }
        }

        // Show edit modal (same logic)
        function showEditModal(e) {
             // Use closest to get the button even if icon is clicked
            const button = e.target.closest('.edit-habit');
             if (!button) return;

            const habitId = button.getAttribute('data-id');
            const habit = habits.find(h => h.id === habitId);

            if (habit) {
                currentEditId = habitId;
                editHabitInput.value = habit.text;
                editModal.classList.add('show');
                editHabitInput.focus(); // Focus input when modal opens
            }
        }

        // Save edited habit (same logic)
        function saveEdit() {
            const text = editHabitInput.value.trim();
            if (text === '' || !currentEditId) return;

            const habitIndex = habits.findIndex(h => h.id === currentEditId);
            if (habitIndex !== -1) {
                habits[habitIndex].text = text;
                saveHabits();
            }

            closeModal();
        }

         // Edit on Enter key in modal
        editHabitInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                saveEdit();
            }
        });

        // Close modal (same logic)
        function closeModal() {
            editModal.classList.remove('show');
            currentEditId = null;
        }

        // --- Calculation Functions (Same logic, more robust checks) ---

        function calculateStreak() {
            let streak = 0;
            let currentDate = new Date(); // Start from today

            while (true) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const relevantHabits = habits.filter(habit => new Date(habit.createdAt) <= currentDate);

                // Break if no relevant habits existed on this day OR no history for this day
                if (relevantHabits.length === 0) break;
                 if (!habitHistory[dateStr] || !habitHistory[dateStr].completed) {
                     // If it's not today, break the streak. If it IS today, streak is 0 but don't break yet (allow future checks).
                     if (dateStr !== today) break;
                 }

                const completedOnDate = habitHistory[dateStr]?.completed || [];
                const allCompleted = relevantHabits.every(habit => completedOnDate.includes(habit.id));

                if (!allCompleted) {
                     // If today's habits aren't all complete, streak is 0.
                     // If a previous day's habits weren't all complete, break the loop.
                     if (dateStr !== today) break;
                     else {
                         // Reset streak if today isn't fully complete (relevant for initial load)
                         // But only if today actually has history/completed entries
                         if (habitHistory[today] && habitHistory[today].completed) streak = 0;
                         break; // Stop checking backwards once today is evaluated
                     }
                 }

                // Only increment streak if all relevant habits were completed
                 if (allCompleted) {
                    streak++;
                 }

                // Move to the previous day
                currentDate.setDate(currentDate.getDate() - 1);
            }

            return streak;
        }


        function calculateCompletionRate() {
             if (habits.length === 0) return 0;

            const historyDates = Object.keys(habitHistory);
            if (historyDates.length === 0) return 0;

            let totalCompleted = 0;
            let totalPossible = 0;

            historyDates.forEach(dateStr => {
                const date = new Date(dateStr);
                 // Ensure we only count days that actually have completion data
                 if (!habitHistory[dateStr] || !habitHistory[dateStr].completed) return;

                const completedOnDate = habitHistory[dateStr].completed;

                habits.forEach(habit => {
                    // Only count if the habit existed on that date
                    if (new Date(habit.createdAt).setHours(0,0,0,0) <= date.setHours(0,0,0,0)) {
                        totalPossible++;
                        if (completedOnDate.includes(habit.id)) {
                            totalCompleted++;
                        }
                    }
                });
            });

            return totalPossible === 0 ? 0 : Math.round((totalCompleted / totalPossible) * 100);
        }

        function calculateTotalCompleted() {
            let total = 0;
            Object.values(habitHistory).forEach(day => {
                if (day && day.completed) { // Check if day and day.completed exist
                    total += day.completed.length;
                }
            });
            return total;
        }

        // Update stats (same logic)
        function updateStats() {
            const streak = calculateStreak();
            const completionRate = calculateCompletionRate();
            const totalCompleted = calculateTotalCompleted();

            currentStreakElement.textContent = streak;
            completionRateElement.textContent = `${completionRate}%`;
            totalCompletedElement.textContent = totalCompleted;
        }

        // Render calendar (same logic, uses CSS classes now)
        function renderCalendar() {
            calendarElement.innerHTML = '';
            const days = [];
            const todayDate = new Date();
            const todayStr = todayDate.toISOString().split('T')[0];

            for (let i = 27; i >= 0; i--) {
                const date = new Date();
                date.setDate(todayDate.getDate() - i);
                days.push(date);
            }

            days.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayOfMonth = date.getDate();

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = dayOfMonth;

                // Check if *any* relevant habit was completed on this day for visual feedback
                const relevantHabits = habits.filter(habit => new Date(habit.createdAt) <= date);
                const completedOnDate = habitHistory[dateStr]?.completed || [];
                const anyCompleted = relevantHabits.some(habit => completedOnDate.includes(habit.id));

                 if (anyCompleted) {
                    dayElement.classList.add('has-completed');
                    // Optional: Add a title showing which habits were completed
                     const completedNames = relevantHabits
                         .filter(h => completedOnDate.includes(h.id))
                         .map(h => h.text);
                     if (completedNames.length > 0) {
                         dayElement.title = `Completed: ${completedNames.join(', ')}`;
                     }
                 }


                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }

                calendarElement.appendChild(dayElement);
            });
        }

        // Event listeners (same logic)
        addHabitBtn.addEventListener('click', addHabit);
        habitInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') addHabit();
        });

        saveEditBtn.addEventListener('click', saveEdit);
        cancelEditBtn.addEventListener('click', closeModal);
        closeModalBtn.addEventListener('click', closeModal);

        // Close modal if clicking outside the content
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                closeModal();
            }
        });

        // Initial render
        renderHabits();
        renderCalendar();
        // updateStats is called within renderHabits and renderCalendar now
    </script>
</body>
</html>