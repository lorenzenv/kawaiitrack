<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✩ awesomeee ✩</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Vercel will generate this file during build -->
    <script src="config.js"></script>

    <style>
        :root {
            /* --- Kawaii Color Palette --- */
            --primary: #ffafcc;
            /* Soft Pink */
            --primary-light: #ffc0db;
            /* Lighter Pink */
            --primary-dark: #ff9eb5;
            /* Darker Pink */
            --secondary: #a2d2ff;
            /* Baby Blue */
            --accent: #fcf6bd;
            /* Pale Yellow */
            --success: #b0f2c2;
            /* Mint Green */
            --success-dark: #87e0a6;
            --danger: #ffb3c1;
            /* Soft Red/Pink */
            --danger-dark: #ff9bad;
            --background-start: #fff0f5;
            /* Lavender Blush Start */
            --background-end: #ffffff;
            /* White End */
            --card: #ffffff;
            --card-completed-bg: #f0fff5;
            /* Background for completed items */
            --text: #6d6875;
            /* Muted Purple/Gray */
            --text-light: #a39daa;
            /* Lighter Muted Purple */
            --border: #ffe5ec;
            /* Very Light Pink */
            --border-radius: 20px;
            --shadow: 0 5px 15px -3px rgba(255, 175, 204, 0.15), 0 4px 6px -4px rgba(255, 175, 204, 0.1);
            --kawaii-font: 'M PLUS Rounded 1c', sans-serif;

            /* --- HSL Color values for Calendar Gradient --- */
            --calendar-hue: 140;
            /* Hue for the green */
            --calendar-sat-max: 70%;
            /* Max saturation for 100% */
            --calendar-sat-min: 40%;
            /* Min saturation for >0% */
            --calendar-light-max: 98%;
            /* Lightness for >0% but not 100% */
            --calendar-light-min: 82%;
            /* Lightness for 100% */
            --calendar-bg-base: #ffffff;
            /* Base background */
            --calendar-bg-empty: #fffafa;
            /* BG for calendar grid */
        }

        /* --- Layout for side-by-side cards --- */
        .main-content-wrapper {
            display: flex;
            gap: 2.5rem;
            /* Match card margin-bottom */
            align-items: flex-start;
            /* Align items to the top */
        }

        .main-content-wrapper>.card {
            margin-bottom: 0;
            /* Remove bottom margin as gap handles spacing */
        }

        .main-content-wrapper>#habits-card {
            flex: 2;
            /* Give habits more space */
        }

        .main-content-wrapper>.stats-section {
            flex: 1;
            /* Calendar takes less space */
            min-width: 300px;
            /* Ensure calendar doesn't get too squished */
            /* Optionally add a max-width if needed */
        }

        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--kawaii-font);
        }

        body {
            background-image: linear-gradient(to bottom, var(--background-start), var(--background-end)),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'%3E%3Cpath d='M14 0 L16.09 5.36 L21.88 5.36 L17.4 8.64 L19.5 14 L14 10.72 L8.5 14 L10.6 8.64 L6.12 5.36 L11.91 5.36 Z' fill='%23FFECF2' fill-opacity='0.5'/%3E%3C/svg%3E");
            background-color: var(--background-start);
            color: var(--text);
            min-height: 100vh;
            padding: 3rem;
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 2rem;
            text-align: center;
            animation: fadeInDown 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            position: relative;
        }

        h1 {
            color: var(--primary);
            font-size: 3rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7);
        }

        h1::before,
        h1::after {
            content: '✩ ';
            opacity: 0.8;
        }

        .date {
            color: var(--text-light);
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .motivation-quote {
            font-size: 1.05rem;
            color: var(--primary-dark);
            font-style: italic;
            margin-bottom: 2rem;
            min-height: 1.3em;
            display: inline-block;
            background-color: rgba(255, 255, 255, 0.6);
            padding: 0.4rem 1rem;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(255, 175, 204, 0.1);
            transition: opacity 0.2s linear;
            opacity: 1;
        }

        .motivation-quote::before {
            content: '✨ ';
        }

        .motivation-quote::after {
            content: ' ✨';
        }

        .card {
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            transition: transform 0.25s ease-out, box-shadow 0.25s ease-out;
        }

        .card:hover {
            transform: translateY(-4px) scale(1.015);
            box-shadow: 0 10px 25px -5px rgba(255, 175, 204, 0.2), 0 8px 12px -6px rgba(255, 175, 204, 0.15);
        }

        .card::before {
            content: '♡';
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 1.8rem;
            color: var(--primary-light);
            opacity: 0.5;
        }

        .form-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            color: var(--text);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fffafa;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(255, 175, 204, 0.3);
        }

        button {
            cursor: pointer;
            padding: 1rem 1.8rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 700;
            transition: background-color 0.2s ease, transform 0.15s ease-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px) scale(1.03);
        }

        button:active {
            transform: translateY(0px) scale(0.98);
        }

        button:disabled {
            background-color: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Added disabled style */
        .btn-small {
            padding: 0.6rem 1rem;
            font-size: 0.95rem;
            border-radius: 15px;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .btn-secondary {
            background-color: var(--text-light);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--text);
        }

        .habit-list {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            min-height: 60px;
            /* Prevent collapse */
        }

        @keyframes flash {
            0% {
                background-color: var(--accent);
                transform: scale(1.02);
            }

            100% {
                background-color: var(--card);
                transform: scale(1);
            }
        }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 1.2rem 1.5rem;
            background-color: var(--card);
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            transition: all 0.3s ease-out;
            animation: popIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            opacity: 0;
            transform: scale(0.98);
        }

        .habit-item.flash-add {
            animation: flash 0.4s ease-out forwards;
        }

        .habit-item:hover {
            transform: translateY(-4px) scale(1.015);
            border-color: var(--primary-light);
            box-shadow: var(--shadow);
        }

        .habit-item.completed {
            border-left: 6px solid var(--success);
            background-color: var(--card-completed-bg);
        }

        .habit-checkbox {
            margin-right: 1.5rem;
            width: 28px;
            height: 28px;
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .habit-checkbox::after {
            font-family: "Font Awesome 6 Free";
            content: "\f004";
            font-weight: 900;
            position: absolute;
            color: var(--success);
            font-size: 16px;
            transform: scale(0);
            transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .habit-item.completed .habit-checkbox {
            background-color: var(--success);
            border-color: var(--success-dark);
            transform: rotate(10deg) scale(1.15);
        }

        .habit-item.completed .habit-checkbox::after {
            transform: scale(1);
            color: white;
        }

        .habit-text {
            flex: 1;
            font-size: 1.15rem;
            font-weight: 500;
            word-break: break-word;
            margin-right: 1rem;
            transition: color 0.3s ease, text-decoration-color 0.3s ease;
        }

        .habit-item.completed .habit-text {
            text-decoration: line-through;
            text-decoration-color: var(--primary);
            text-decoration-thickness: 2px;
            color: var(--text-light);
            font-style: italic;
        }

        .habit-actions {
            display: flex;
            gap: 0.8rem;
            align-items: center;
        }

        .habit-actions button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.3rem;
            padding: 0.4rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
        }

        .habit-actions button:hover {
            color: var(--primary);
            background-color: #fff0f5;
            transform: scale(1.15);
        }

        .habit-actions .delete-habit:hover {
            color: var(--danger-dark);
            background-color: #fff0f0;
        }

        .empty-state,
        .loading-state

        /* Added loading state style */
            {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            background-color: #fffafa;
            margin-top: 2rem;
        }

        .empty-state p,
        .loading-state p {
            font-size: 1.2rem;
            line-height: 1.7;
        }

        .empty-state::before {
            content: '(づ ◕‿◕ )づ';
            font-size: 2.5rem;
            display: block;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }

        .loading-state::before {
            content: '🌸';
            font-size: 2.5rem;
            display: block;
            margin-bottom: 1.5rem;
            color: var(--secondary);
            animation: spin 1.8s linear infinite;
        }

        /* Loading spinner */
        .streak-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 2.5rem;
            gap: 1.5rem;
            animation: fadeInUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .streak-card {
            flex: 1;
            padding: 1.5rem;
            text-align: center;
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.25s ease-out, box-shadow 0.25s ease-out;
            position: relative;
            overflow: hidden;
        }

        .streak-card::after {
            content: '✨';
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 1.4rem;
            opacity: 0.6;
            transform: rotate(-15deg);
        }

        .streak-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(255, 175, 204, 0.2), 0 8px 12px -6px rgba(255, 175, 204, 0.15);
        }

        .streak-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            color: var(--primary);
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .streak-value:hover {
            color: var(--primary-dark);
            transform: scale(1.05);
        }

        .streak-label {
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .streak-label i {
            color: var(--primary-light);
            font-size: 1.1em;
        }

        .stats-section {
            margin-top: 3rem;
            animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.1s forwards;
        }

        .stats-title {
            font-size: 1.8rem;
            margin-bottom: 2rem;
            color: var(--secondary);
            text-align: center;
            font-weight: 700;
        }

        .stats-title::before {
            content: '🗓️ ';
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.8rem;
            background-color: var(--calendar-bg-empty);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--calendar-bg-base);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: default;
            border: 1px solid var(--border);
            transition: all 0.25s ease;
            position: relative;
        }

        .calendar-day.fully-completed {
            color: var(--text);
            font-weight: 700;
            transform: scale(1.08);
            border-color: var(--success-dark);
            box-shadow: 0 0 10px rgba(176, 242, 194, 0.5);
        }

        .calendar-day.fully-completed::after {
            content: '★';
            position: absolute;
            top: 3px;
            right: 4px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .calendar-day.today {
            border: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 700;
            z-index: 1;
        }

        .calendar-day:not(.fully-completed):hover {
            transform: scale(1.05);
            border-color: var(--primary-light);
            background-color: hsla(var(--calendar-hue), 20%, 95%, 0.5);
        }

        .calendar-day.fully-completed:hover {
            box-shadow: 0 0 15px rgba(176, 242, 194, 0.6);
        }

        .reset-data-container {
            text-align: center;
            margin-top: 2rem;
        }

        #reset-data-btn {
            background-color: var(--text-light);
            color: white;
            font-size: 1rem;
            padding: 0.8rem 1.5rem;
        }

        #reset-data-btn:hover {
            background-color: var(--danger);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 175, 204, 0.3);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.35s ease, visibility 0s linear 0.35s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.35s ease, visibility 0s linear 0s;
        }

        .modal-content {
            background-color: var(--card);
            padding: 3rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 550px;
            transform: scale(0.9) translateY(-30px);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 15px 40px -10px rgba(255, 175, 204, 0.5);
            border: 2px solid var(--primary-light);
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 700;
        }

        .modal-title::before {
            content: '✏️ ';
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease, transform 0.3s ease;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--danger);
            transform: rotate(180deg) scale(1.1);
        }

        .modal-body {
            margin-bottom: 2.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1.2rem;
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(15px);
            }

            60% {
                opacity: 1;
                transform: scale(1.02) translateY(-5px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeInDown {
            0% {
                opacity: 0;
                transform: translateY(-30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* --- Responsive Layout --- */
        @media (max-width: 900px) {

            /* Adjust breakpoint as needed */
            .main-content-wrapper {
                flex-direction: column;
                gap: 2rem;
            }

            .main-content-wrapper>.card {
                margin-bottom: 2rem;
                /* Re-add margin for vertical stacking */
            }

            .main-content-wrapper>#habits-card,
            .main-content-wrapper>.stats-section {
                flex: 1;
                /* Reset flex basis */
                width: 100%;
                /* Take full width when stacked */
                min-width: initial;
                /* Reset min-width */
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>✩ awesomeee ✩</h1>
            <div class="date" id="current-date">Loading date...</div>
            <div class="motivation-quote" id="motivation-quote">Let's make today amazing!</div>
        </header>

        <div class="main-content-wrapper">
            <div class="card" id="habits-card">
                <div class="form-group">
                    <input type="text" id="habit-input" placeholder="Add a growing habit! 🌱" autocomplete="off"
                        disabled>
                    <button id="add-habit-btn" disabled><i class="fa-solid fa-plus"></i> Add!</button>
                </div>

                <!-- Added Loading State Div -->
                <div class="loading-state" id="loading-state">
                    <p>Loading your beautiful habits... Please wait 💖</p>
                </div>

                <div class="habit-list" id="habit-list" style="display: none;">
                    <!-- Habits will be added here -->
                </div>

                <div class="empty-state" id="empty-state" style="display: none;">
                    <p>No habits blooming yet! Plant the first seed today! (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧</p>
                </div>
            </div>

            <div class="card stats-section">
                <h2 class="stats-title">Your Lovely Progress (Last 28 Days)</h2>
                <div class="calendar" id="calendar">
                    <!-- Calendar days will be added here -->
                </div>
                <div class="reset-data-container">
                    <button id="reset-data-btn" class="btn-small" disabled><i class="fa-solid fa-arrows-rotate"></i>
                        Reset
                        Data</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Habit</h2>
                <button class="modal-close" id="close-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="edit-habit-input" placeholder="New habit name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-edit"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button id="save-edit"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <script type="module" defer>
        // === WARNING ===
        // This setup does NOT use user authentication or Row Level Security.
        // Data is publicly readable and writable via the Anon Key.
        // === === === ===

        // === DOM Elements ===
        const habitInput = document.getElementById('habit-input');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const habitList = document.getElementById('habit-list');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state'); // Get loading state div
        const currentDateElement = document.getElementById('current-date');
        const editModal = document.getElementById('edit-modal');
        const editHabitInput = document.getElementById('edit-habit-input');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const closeModalBtn = document.getElementById('close-modal');
        const calendarElement = document.getElementById('calendar');
        const motivationQuoteElement = document.getElementById('motivation-quote');
        const resetDataBtn = document.getElementById('reset-data-btn');

        // === Supabase Setup ===
        let supabaseClient = null; // RENAME variable to avoid confusion
        try {
            // Check config variables from config.js / Vercel env vars
            if (typeof window.SUPABASE_URL === 'undefined' || window.SUPABASE_URL === '' || typeof window.SUPABASE_ANON_KEY === 'undefined' || window.SUPABASE_ANON_KEY === '') {
                throw new Error("Supabase config variables not found on window. Check config.js or Vercel env vars.");
            }

            const supabaseUrl = window.SUPABASE_URL;
            const supabaseKey = window.SUPABASE_ANON_KEY;

            // Check if the Supabase library object exists globally (loaded by the CDN script)
            if (typeof supabase === 'undefined' || !supabase || typeof supabase.createClient !== 'function') {
                // Fallback check on window object just in case
                if (typeof window.supabase === 'undefined' || !window.supabase || typeof window.supabase.createClient !== 'function') {
                    throw new Error("Supabase client library (supabase-js) not loaded correctly from CDN.");
                }
                // Use the one found on window if the global one isn't there
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                // Use the globally found 'supabase' object directly
                supabaseClient = supabase.createClient(supabaseUrl, supabaseKey); // <-- Use the library's createClient
            }

            console.log("Supabase client initialized.");
            console.log("⚠️ App running without user authentication. Data is public.");
        } catch (error) {
            console.error("Supabase Initialization Error:", error);
            alert(`Fatal Error: Could not initialize Supabase. ${error.message}`);
            // Disable the whole app visually if init fails
            document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: var(--danger); font-family: var(--kawaii-font);"><h1>Initialization Failed</h1><p>Could not connect to the data store. Please check the console and configuration.</p></div>`;
        }

        // === State ===
        let habits = []; // Will be fetched from Supabase
        let completions = {}; // { 'YYYY-MM-DD': [habitId1, ...] } - Will be fetched
        let currentEditId = null;
        let today = ''; // Set in initializeApp
        let isLoading = true; // Tracks loading state

        // === Motivational Quotes ===
        const quotes = [
            "One step at a time!", "You've got this! ✨", "Keep shining brightly!",
            "Progress, not perfection.", "Believe in your potential!",
            "Small habits lead to big changes.", "Make today count!",
            "You are capable of amazing things!", "Grow stronger every day.",
            "Be proud of your efforts!", "Consistency is key!", "Plant positivity, harvest happiness."
        ];

        // === Helper Functions ===
        function formatDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const todayDate = new Date();
            currentDateElement.textContent = todayDate.toLocaleDateString('en-US', options);
            return todayDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

        function setLoading(loading) {
            isLoading = loading;
            habitInput.disabled = loading;
            addHabitBtn.disabled = loading;
            resetDataBtn.disabled = loading;
            // Disable habit interaction buttons during load - select within habitList IF it exists
            habitList?.querySelectorAll('button, .habit-checkbox').forEach(el => el.disabled = loading);


            if (loading) {
                loadingState.style.display = 'block';
                habitList.style.display = 'none';
                emptyState.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
                renderHabits(); // Render AFTER loading is false
            }
        }

        function escapeHTML(str) {
            const div = document.createElement('div');
            if (typeof str === 'string') {
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
            }
            return '';
        }

        // === Supabase Interaction Functions ===
        async function loadInitialData() {
            if (!supabaseClient) return; // Don't proceed if Supabase failed to init
            setLoading(true);
            try {
                const habitsPromise = supabaseClient // Use supabaseClient
                    .from('habits')
                    .select('id, text, created_at')
                    .order('created_at', { ascending: true });

                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30); // Fetch range for calendar
                const startDateString = startDate.toISOString().split('T')[0];
                const completionsPromise = supabaseClient // Use supabaseClient
                    .from('completions')
                    .select('habit_id, completed_at')
                    .gte('completed_at', startDateString);

                const [habitsResult, completionsResult] = await Promise.all([habitsPromise, completionsPromise]);

                if (habitsResult.error) throw habitsResult.error;
                habits = habitsResult.data || [];

                if (completionsResult.error) throw completionsResult.error;
                completions = {}; // Reset completions object
                (completionsResult.data || []).forEach(comp => {
                    const dateStr = comp.completed_at;
                    if (!completions[dateStr]) {
                        completions[dateStr] = [];
                    }
                    if (!completions[dateStr].includes(comp.habit_id)) {
                        completions[dateStr].push(comp.habit_id);
                    }
                });

                console.log("Data loaded:", { habits: habits.length, completionDates: Object.keys(completions).length });
                updateStats();
                renderCalendar();

            } catch (error) {
                console.error("Error loading data:", error.message);
                alert(`Oops! 🥺 Could not load data: ${error.message}`);
                setLoading(true); // Stay in loading state visually
                loadingState.innerHTML = `<p>Error loading data. Please refresh. (｡•́︿•̀｡)</p>`; // Update message
            } finally {
                // Final state update and render happens via setLoading
                setLoading(false);
            }
        }

        async function addHabit() {
            if (!supabaseClient || isLoading) return;
            const text = habitInput.value.trim();
            if (text === '') return;

            setLoading(true);
            try {
                const { data, error } = await supabaseClient // Use supabaseClient
                    .from('habits')
                    .insert({ text: text })
                    .select()
                    .single();

                if (error) throw error;

                if (data) {
                    habits.push(data);
                    habitInput.value = '';
                    // UI update via setLoading(false) -> renderHabits()
                } else {
                    console.warn("Habit insert successful but no data returned.");
                }
            } catch (error) {
                console.error("Error adding habit:", error.message);
                alert(`Couldn't add habit: ${error.message} (｡•́︿•̀｡)`);
            } finally {
                setLoading(false); // Re-enable UI and trigger re-render
            }
        }

        async function toggleHabit(e) {
            if (!supabaseClient || isLoading) return;
            const checkbox = e.target.closest('.habit-checkbox'); // Target the container div
            if (!checkbox) return; // Exit if click wasn't on a checkbox or its content

            const habitId = parseInt(checkbox.getAttribute('data-id'));
            const habitItem = checkbox.closest('.habit-item');
            if (isNaN(habitId) || !habitItem) return;

            const isCurrentlyCompleted = habitItem.classList.contains('completed');
            const targetState = !isCurrentlyCompleted;

            // --- Optimistic UI Update ---
            habitItem.classList.toggle('completed', targetState);
            checkbox.setAttribute('aria-checked', targetState.toString());
            checkbox.setAttribute('title', targetState ? 'Mark as incomplete' : 'Mark as complete');

            if (!completions[today]) completions[today] = [];
            const completedIndex = completions[today].indexOf(habitId);
            if (targetState) {
                if (completedIndex === -1) completions[today].push(habitId);
            } else {
                if (completedIndex > -1) completions[today].splice(completedIndex, 1);
            }
            updateStats();
            renderCalendar();
            // --- End Optimistic Update ---

            checkbox.style.pointerEvents = 'none'; // Prevent further clicks during processing

            try {
                if (targetState) { // Insert completion
                    const { error } = await supabaseClient // Use supabaseClient
                        .from('completions')
                        .insert({ habit_id: habitId, completed_at: today });
                    if (error && error.code === '23505') { console.warn(`Completion already exists for habit ${habitId} on ${today}.`); }
                    else if (error) { throw error; }
                } else { // Delete completion
                    const { error } = await supabaseClient // Use supabaseClient
                        .from('completions')
                        .delete()
                        .match({ habit_id: habitId, completed_at: today });
                    if (error) throw error;
                }
                console.log(`Completion toggled successfully for habit ${habitId} on ${today}`);
            } catch (error) {
                console.error("Error toggling completion:", error.message);
                alert(`Couldn't update completion: ${error.message} Σ(°ロ°)`);
                // --- Revert Optimistic Update on Error ---
                habitItem.classList.toggle('completed', !targetState);
                checkbox.setAttribute('aria-checked', (!targetState).toString());
                checkbox.setAttribute('title', !targetState ? 'Mark as incomplete' : 'Mark as complete');
                if (targetState && completedIndex === -1) { // If we added it optimistically
                    const revertIndex = completions[today]?.indexOf(habitId);
                    if (revertIndex > -1) completions[today].splice(revertIndex, 1);
                } else if (!targetState && completedIndex > -1) { // If we removed it optimistically
                    if (!completions[today]?.includes(habitId)) completions[today].push(habitId);
                }
                updateStats();
                renderCalendar();
                // --- End Revert ---
            } finally {
                checkbox.style.pointerEvents = 'auto'; // Re-enable checkbox
            }
        }

        async function performDeletion(habitId) {
            if (!supabaseClient) return;
            try {
                const { error } = await supabaseClient // Use supabaseClient
                    .from('habits')
                    .delete()
                    .match({ id: habitId });
                if (error) throw error;

                habits = habits.filter(habit => habit.id !== habitId);
                Object.keys(completions).forEach(date => {
                    completions[date] = completions[date]?.filter(id => id !== habitId) ?? [];
                });

                renderHabits(); // Re-render list fully
            } catch (error) {
                console.error("Error performing deletion:", error.message);
                alert(`Couldn't delete habit from database: ${error.message} (ಥ﹏ಥ)`);
                renderHabits(); // Re-render to potentially bring item back if DB delete failed
            } finally {
                setLoading(false); // Ensure UI is re-enabled
            }
        }

        function deleteHabit(e) {
            const button = e.target.closest('.delete-habit');
            if (!button || isLoading) return;
            const habitId = parseInt(button.getAttribute('data-id'));
            if (isNaN(habitId)) return;
            const habitText = habits.find(h => h.id === habitId)?.text || 'this habit';

            if (confirm(`Delete "${escapeHTML(habitText)}" forever? (｡•́︿•̀｡) This cannot be undone.`)) {
                const habitItem = button.closest('.habit-item');
                if (habitItem) {
                    setLoading(true); // Disable actions during animation/delete
                    habitItem.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, margin-bottom 0.3s ease-out, padding 0.3s ease-out, height 0.3s ease-out';
                    habitItem.style.opacity = '0';
                    habitItem.style.transform = 'scale(0.95)';
                    habitItem.style.marginBottom = `-${getComputedStyle(habitList).gap}`; // Collapse gap
                    habitItem.style.paddingTop = '0';
                    habitItem.style.paddingBottom = '0';
                    habitItem.style.height = '0';
                    habitItem.style.borderWidth = '0'; // Collapse border visually
                    setTimeout(() => performDeletion(habitId), 300); // Match transition
                } else {
                    performDeletion(habitId); // Fallback
                }
            }
        }

        async function saveEdit() {
            if (!supabaseClient || isLoading) return;
            const newText = editHabitInput.value.trim();
            if (newText === '' || !currentEditId) return;

            const habitIndex = habits.findIndex(h => h.id === currentEditId);
            const originalText = (habitIndex !== -1) ? habits[habitIndex].text : '';

            // --- Optimistic UI Update ---
            if (habitIndex !== -1) {
                habits[habitIndex].text = newText;
                // Update the text directly in the DOM for instant feedback without full re-render
                const habitItem = habitList.querySelector(`.habit-item[data-id="${currentEditId}"] .habit-text`);
                if (habitItem) habitItem.textContent = newText;
                // Don't call renderHabits() here to avoid list shift/animation retrigger
            }
            closeModal();
            // --- End Optimistic Update ---

            setLoading(true); // Prevent actions while saving
            try {
                const { data, error } = await supabaseClient // Use supabaseClient
                    .from('habits')
                    .update({ text: newText })
                    .match({ id: currentEditId })
                    .select()
                    .single();

                if (error) throw error;
                console.log("Habit updated successfully in DB:", data);

            } catch (error) {
                console.error("Error updating habit:", error.message);
                alert(`Couldn't save changes: ${error.message} (ノಠ益ಠ)ノ彡┻━┻`);
                // --- Revert Optimistic Update on Error ---
                if (habitIndex !== -1) {
                    habits[habitIndex].text = originalText; // Restore local state
                    const habitItemText = habitList.querySelector(`.habit-item[data-id="${currentEditId}"] .habit-text`);
                    if (habitItemText) habitItemText.textContent = originalText; // Restore DOM text
                }
                // --- End Revert ---
            } finally {
                setLoading(false); // Re-enable UI
            }
        }

        async function handleResetData() {
            if (!supabaseClient || isLoading) return;
            if (confirm('Are you absolutely sure? This will delete ALL your habits and history permanently! Σ(°ロ°)')) {
                if (confirm('Last chance! Are you really, really sure you want to reset everything?')) {
                    setLoading(true);
                    try {
                        // It's safer to delete from the referencing table first if cascade isn't 100% trusted or set up
                        const { error: completionsError } = await supabaseClient // Use supabaseClient
                            .from('completions')
                            .delete()
                            .neq('id', -1); // Condition to delete all rows
                        if (completionsError) throw completionsError;
                        console.log("Completions deleted from DB.");

                        const { error: habitsError } = await supabaseClient // Use supabaseClient
                            .from('habits')
                            .delete()
                            .neq('id', -1); // Condition to delete all rows
                        if (habitsError) throw habitsError;
                        console.log("Habits deleted from DB.");

                        // Reset local state
                        habits = [];
                        completions = {};
                        displayRandomQuote();

                    } catch (error) {
                        console.error("Error resetting data:", error.message);
                        alert(`Couldn't reset data: ${error.message} (ಥ﹏ಥ)`);
                    } finally {
                        setLoading(false); // Re-enable UI and trigger re-render
                    }
                }
            }
        }

        // === Rendering Functions ===
        function renderHabits() {
            if (isLoading) return; // Don't render while initial loading

            const todayCompletions = completions[today] || [];
            const fragment = document.createDocumentFragment(); // Use fragment for performance

            if (habits.length === 0) {
                emptyState.style.display = 'block';
                habitList.style.display = 'none';
                habitList.innerHTML = ''; // Clear just in case
            } else {
                emptyState.style.display = 'none';
                habitList.style.display = 'flex'; // Show list container

                // Check if habit list element exists before proceeding
                if (!habitList) {
                    console.error("Habit list element not found!");
                    return;
                }

                habits.forEach((habit, index) => {
                    const isCompleted = todayCompletions.includes(habit.id);
                    const habitElement = document.createElement('div');
                    habitElement.className = `habit-item ${isCompleted ? 'completed' : ''}`;
                    habitElement.dataset.id = habit.id; // Use dataset for ID
                    // Apply animation only if it wasn't just added (avoids double animation)
                    if (!habitElement.classList.contains('flash-add')) {
                        habitElement.style.animationDelay = `${index * 0.07}s`;
                    }


                    habitElement.innerHTML = `
                        <div class="habit-checkbox" data-id="${habit.id}" role="checkbox" aria-checked="${isCompleted}" title="${isCompleted ? 'Mark as incomplete' : 'Mark as complete'}"></div>
                        <div class="habit-text">${escapeHTML(habit.text)}</div>
                        <div class="habit-actions">
                            <button class="btn-small edit-habit" data-id="${habit.id}" title="Edit Habit"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn-small btn-danger delete-habit" data-id="${habit.id}" title="Delete Habit"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    fragment.appendChild(habitElement);
                });
                habitList.innerHTML = ''; // Clear previous content safely
                habitList.appendChild(fragment); // Add new content efficiently
            }

            // Event listeners should be attached after rendering
            // addHabitEventListeners(); // This is now handled by delegation in initializeApp

            updateStats(); // Always update stats after render
            renderCalendar(); // Always update calendar after render
        }

        function renderCalendar() {
            if (isLoading && !calendarElement.querySelector('.loading-placeholder')) {
                calendarElement.innerHTML = '<div class="loading-placeholder" style="text-align: center; color: var(--text-light); padding: 2rem;">Loading calendar...</div>';
                return;
            }
            if (isLoading) return;

            const placeholder = calendarElement.querySelector('.loading-placeholder');
            if (placeholder) placeholder.remove();

            calendarElement.innerHTML = ''; // Clear previous calendar
            const days = [];
            const todayDate = new Date();
            const todayStr = todayDate.toISOString().split('T')[0];

            const computedStyle = getComputedStyle(document.documentElement);
            const hue = parseInt(computedStyle.getPropertyValue('--calendar-hue').trim());
            const parseCssValue = (value) => parseInt(value.trim().replace('%', ''));
            const satMax = parseCssValue(computedStyle.getPropertyValue('--calendar-sat-max'));
            const satMin = parseCssValue(computedStyle.getPropertyValue('--calendar-sat-min'));
            const lightMax = parseCssValue(computedStyle.getPropertyValue('--calendar-light-max'));
            const lightMin = parseCssValue(computedStyle.getPropertyValue('--calendar-light-min'));

            for (let i = 27; i >= 0; i--) {
                const date = new Date();
                date.setDate(todayDate.getDate() - i);
                days.push(date);
            }

            days.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayOfMonth = date.getDate();
                const dateObj = new Date(dateStr);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = dayOfMonth;

                const relevantHabits = habits.filter(habit =>
                    new Date(habit.created_at).setHours(0, 0, 0, 0) <= dateObj.setHours(0, 0, 0, 0)
                );
                const completedOnDate = completions[dateStr] || [];

                let numRelevant = relevantHabits.length;
                let numCompleted = 0;
                if (numRelevant > 0) {
                    numCompleted = relevantHabits.filter(habit => completedOnDate.includes(parseInt(habit.id))).length; // Ensure ID comparison is number-to-number if needed
                }
                const completionPercentage = numRelevant > 0 ? (numCompleted / numRelevant) : 0;

                dayElement.classList.remove('fully-completed');
                if (completionPercentage > 0) {
                    const currentSat = satMin + (satMax - satMin) * completionPercentage;
                    const currentLight = lightMax - (lightMax - lightMin) * completionPercentage;
                    dayElement.style.backgroundColor = `hsl(${hue}, ${currentSat}%, ${currentLight}%)`;
                    if (completionPercentage === 1) {
                        dayElement.classList.add('fully-completed');
                    }
                } else {
                    dayElement.style.backgroundColor = ''; // Use CSS default
                }

                if (numRelevant > 0) {
                    dayElement.title = `Completed ${numCompleted}/${numRelevant} habits on ${date.toLocaleDateString()}`;
                } else {
                    dayElement.title = date.toLocaleDateString();
                }
                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }
                calendarElement.appendChild(dayElement);
            });
        }

        function calculateStreak() {
            let streak = 0;
            let checkDate = new Date(); // Start from today
            const todayStr = checkDate.toISOString().split('T')[0];

            while (true) {
                const dateStr = checkDate.toISOString().split('T')[0];
                const dateObj = new Date(dateStr);

                const relevantHabits = habits.filter(habit =>
                    new Date(habit.created_at).setHours(0, 0, 0, 0) <= dateObj.setHours(0, 0, 0, 0)
                );

                if (relevantHabits.length === 0) {
                    if (dateStr === todayStr) streak = 0;
                    break;
                }

                const completedToday = completions[dateStr] || [];
                // Ensure IDs are numbers if comparing numbers <-> strings
                const allCompleted = relevantHabits.every(habit => completedToday.includes(parseInt(habit.id)));

                if (!allCompleted) {
                    if (dateStr === todayStr) streak = 0;
                    break;
                }
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            }
            return streak;
        }

        function calculateCompletionRate() {
            if (habits.length === 0) return 0;
            let totalCompleted = 0;
            let totalPossible = 0;

            const firstHabitDate = habits.length > 0
                ? new Date(Math.min(...habits.map(h => new Date(h.created_at).getTime())))
                : new Date();
            firstHabitDate.setHours(0, 0, 0, 0);

            let currentDate = new Date(); currentDate.setHours(0, 0, 0, 0);
            const todayDateOnly = new Date(today).setHours(0, 0, 0, 0);

            while (currentDate >= firstHabitDate && currentDate <= todayDateOnly) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const completedOnDate = completions[dateStr] || [];

                habits.forEach(habit => {
                    if (new Date(habit.created_at).setHours(0, 0, 0, 0) <= currentDate.getTime()) {
                        totalPossible++;
                        // Ensure ID comparison is number-to-number if needed
                        if (completedOnDate.includes(parseInt(habit.id))) {
                            totalCompleted++;
                        }
                    }
                });
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return totalPossible === 0 ? 0 : Math.round((totalCompleted / totalPossible) * 100);
        }

        function calculateTotalCompleted() {
            let total = 0;
            Object.values(completions).forEach(dayCompletions => {
                total += dayCompletions.length;
            });
            return total;
        }

        function updateStats() {
            if (isLoading) return; // Don't calculate if loading
        }

        function displayRandomQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            motivationQuoteElement.style.opacity = '0';
            setTimeout(() => {
                motivationQuoteElement.textContent = quotes[randomIndex];
                motivationQuoteElement.style.opacity = '1';
            }, 200);
        }

        // === Modal Functions ===
        function showEditModal(e) {
            const button = e.target.closest('.edit-habit');
            if (!button || isLoading) return;
            const habitId = parseInt(button.getAttribute('data-id'));
            if (isNaN(habitId)) return;
            const habit = habits.find(h => h.id === habitId);
            if (habit) {
                currentEditId = habitId;
                editHabitInput.value = habit.text;
                editModal.classList.add('show');
                setTimeout(() => editHabitInput.focus(), 50);
            }
        }

        function closeModal() {
            editModal.classList.remove('show');
            currentEditId = null;
            editHabitInput.value = '';
        }

        // === Event Listener Attachment Function ===
        function addHabitEventListeners() {
            // Use event delegation on the list container for checkbox, edit, delete
            habitList.removeEventListener('click', handleHabitListClick); // Remove old listener
            habitList.addEventListener('click', handleHabitListClick);   // Add new one
        }

        // Delegated event handler for items inside the habit list
        function handleHabitListClick(event) {
            const checkbox = event.target.closest('.habit-checkbox');
            const editButton = event.target.closest('.edit-habit');
            const deleteButton = event.target.closest('.delete-habit');

            if (checkbox) {
                toggleHabit(event); // Pass the original event
                return;
            }
            if (editButton) {
                showEditModal(event); // Pass the original event
                return;
            }
            if (deleteButton) {
                deleteHabit(event); // Pass the original event
                return;
            }
        }

        // === Initialization ===
        function initializeApp() {
            if (!supabaseClient) {
                console.error("Initialization failed: Supabase client not available.");
                // Potentially update UI to show a permanent error if client is null
                return;
            }

            today = formatDate(); // Set global 'today' string
            displayRandomQuote(); // Show initial quote
            setInterval(displayRandomQuote, 15000); // Change quote periodically

            // Add global listeners (outside the habit list)
            addHabitBtn.addEventListener('click', addHabit);
            habitInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') addHabit(); });
            saveEditBtn.addEventListener('click', saveEdit);
            cancelEditBtn.addEventListener('click', closeModal);
            closeModalBtn.addEventListener('click', closeModal);
            editHabitInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') saveEdit(); });
            editModal.addEventListener('click', (e) => { if (e.target === editModal) closeModal(); });
            resetDataBtn.addEventListener('click', handleResetData);

            // Add event listeners for habits list using delegation
            addHabitEventListeners(); // Call this once initially

            loadInitialData(); // Fetch data from Supabase
        }

        // === Start the App ===
        initializeApp();

    </script>
</body>

</html>