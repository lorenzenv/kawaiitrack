<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>✩ Kawaii Habit Tracker ✩</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
        <!-- Supabase Client Library -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <!-- Vercel will generate this file during build -->
        <script src="config.js"></script>  <!-- ADD THIS LINE -->
    <style>
        :root {
            /* --- Kawaii Color Palette --- */
            --primary: #ffafcc; /* Soft Pink */
            --primary-light: #ffc0db; /* Lighter Pink */
            --primary-dark: #ff9eb5; /* Darker Pink */
            --secondary: #a2d2ff; /* Baby Blue */
            --accent: #fcf6bd; /* Pale Yellow */
            --success: #b0f2c2; /* Mint Green */
            --success-dark: #87e0a6;
            --danger: #ffb3c1; /* Soft Red/Pink */
            --danger-dark: #ff9bad;
            --background: #fff0f5; /* Lavender Blush */
            --card: #ffffff;
            --text: #6d6875; /* Muted Purple/Gray */
            --text-light: #a39daa; /* Lighter Muted Purple */
            --border: #ffe5ec; /* Very Light Pink */
            --border-radius: 20px; /* Increased roundness */
            --shadow: 0 5px 15px -3px rgba(255, 175, 204, 0.2), 0 4px 6px -4px rgba(255, 175, 204, 0.15); /* Softer pink shadow */
            --kawaii-font: 'M PLUS Rounded 1c', sans-serif; /* Cute Font */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--kawaii-font); /* Apply cute font */
        }

        body {
            background-color: var(--background);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'%3E%3Cpath d='M14 0 L16.09 5.36 L21.88 5.36 L17.4 8.64 L19.5 14 L14 10.72 L8.5 14 L10.6 8.64 L6.12 5.36 L11.91 5.36 Z' fill='%23FFECF2' fill-opacity='0.5'/%3E%3C/svg%3E"); /* Subtle star pattern */
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
            transition: background-color 0.3s ease; /* Smooth transitions */
        }

        .container {
            max-width: 700px; /* Slightly smaller for cuter proportions */
            margin: 0 auto;
        }

        header {
            margin-bottom: 2.5rem;
            text-align: center;
            animation: fadeInDown 0.5s ease-out;
        }

        h1 {
            color: var(--primary);
            font-size: 2.5rem; /* Slightly larger */
            margin-bottom: 0.5rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7); /* Subtle text shadow */
        }
         h1::before {
            content: '✩ '; /* Star decoration */
            opacity: 0.8;
         }
          h1::after {
            content: ' ✩'; /* Star decoration */
            opacity: 0.8;
         }


        .date {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .card {
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem; /* More padding */
            margin-bottom: 2rem;
            border: 1px solid var(--border);
            position: relative; /* For potential decorations */
            overflow: hidden; /* Ensure decorations don't overflow */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .card:hover {
             transform: translateY(-3px) scale(1.01); /* Subtle lift effect */
             box-shadow: 0 8px 20px -3px rgba(255, 175, 204, 0.25), 0 6px 10px -4px rgba(255, 175, 204, 0.2);
        }

        /* Small heart decoration on card */
        .card::before {
            content: '♡';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: var(--primary-light);
            opacity: 0.5;
        }

        .form-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem; /* More space */
        }

        input[type="text"] {
            flex: 1;
            padding: 0.85rem 1.2rem; /* Slightly larger padding */
            border: 2px solid var(--border); /* Slightly thicker border */
            border-radius: var(--border-radius);
            font-size: 1rem;
            color: var(--text);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fffafa; /* Very light pinkish background */
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(255, 175, 204, 0.3); /* Pink glow on focus */
        }

        button {
            cursor: pointer;
            padding: 0.85rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 700; /* Bolder button text */
            transition: background-color 0.2s ease, transform 0.15s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.02); /* Bouncy hover effect */
        }
        button:active {
            transform: translateY(0px) scale(0.98); /* Press down effect */
        }

        .btn-small {
            padding: 0.5rem 0.8rem;
            font-size: 0.875rem;
            border-radius: 15px; /* Smaller buttons also rounded */
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .habit-list {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* More spacing */
        }

        .habit-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            background-color: white;
            border: 2px solid var(--border); /* Thicker border */
            border-radius: var(--border-radius);
            transition: all 0.25s ease-out;
            animation: popIn 0.4s ease-out forwards; /* Add animation */
            opacity: 0; /* Start hidden for animation */
            transform: scale(0.95);
        }
        /* Stagger animation */
        .habit-item:nth-child(1) { animation-delay: 0.05s; }
        .habit-item:nth-child(2) { animation-delay: 0.1s; }
        .habit-item:nth-child(3) { animation-delay: 0.15s; }
        /* Add more if needed */

        .habit-item:hover {
            transform: translateY(-3px) scale(1.01); /* Lift on hover */
            border-color: var(--primary-light);
            box-shadow: var(--shadow);
        }

        .habit-item.completed {
            border-left: 6px solid var(--success); /* Thicker success border */
            background-color: #f0fff5; /* Light green background */
        }

        /* --- Kawaii Checkbox --- */
        .habit-checkbox {
            margin-right: 1.2rem;
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-light); /* Pink border */
            border-radius: 8px; /* Rounded square */
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
            position: relative;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .habit-checkbox::after {
            /* Using Font Awesome heart */
            font-family: "Font Awesome 6 Free";
            content: "\f004"; /* Heart icon */
            font-weight: 900;
            position: absolute;
            color: var(--success);
            font-size: 14px;
            transform: scale(0); /* Start hidden */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
        }

        .habit-item.completed .habit-checkbox {
            background-color: var(--success); /* Green background when checked */
            border-color: var(--success-dark);
            transform: rotate(10deg) scale(1.1); /* Tilt and grow when checked */
        }

        .habit-item.completed .habit-checkbox::after {
            transform: scale(1); /* Show heart */
            color: white; /* White heart on green background */
        }

        .habit-text {
            flex: 1;
            font-size: 1.05rem; /* Slightly larger text */
            font-weight: 500;
        }

        .habit-item.completed .habit-text {
            text-decoration: line-through;
            text-decoration-color: var(--primary); /* Pink strikethrough */
            text-decoration-thickness: 2px;
            color: var(--text-light);
            font-style: italic;
        }

        .habit-actions {
            display: flex;
            gap: 0.6rem;
            align-items: center; /* Align icons nicely */
        }
        /* Replace buttons with cute icons */
        .habit-actions button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.2rem; /* Icon size */
            padding: 0.3rem;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: none;
            transition: color 0.2s ease, background-color 0.2s ease, transform 0.2s ease;
        }
        .habit-actions button:hover {
            color: var(--primary);
            background-color: #fff0f5; /* Light pink background on hover */
            transform: scale(1.1);
        }
        .habit-actions .delete-habit:hover {
            color: var(--danger-dark);
            background-color: #fff0f0; /* Light red background on hover */
        }


        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-light);
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            background-color: #fffafa;
            margin-top: 1rem;
        }
        .empty-state p {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .empty-state::before {
            content: '(づ ◕‿◕ )づ'; /* Cute emoticon */
            font-size: 2rem;
            display: block;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .streak-section {
            display: flex;
            justify-content: space-around; /* Space out more */
            margin-bottom: 2rem;
            gap: 1rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .streak-card {
            flex: 1;
            padding: 1.2rem;
            text-align: center;
            background-color: var(--card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s ease-out;
            position: relative; /* For potential decorations */
            overflow: hidden;
        }
         .streak-card::after { /* Add a little star decoration */
             content: '✨';
             position: absolute;
             bottom: 5px;
             right: 10px;
             font-size: 1.2rem;
             opacity: 0.6;
             transform: rotate(-15deg);
         }

        .streak-card:hover {
            transform: translateY(-4px);
        }

        .streak-value {
            font-size: 2.5rem; /* Bigger numbers */
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--primary); /* Pink numbers */
            transition: color 0.3s ease; /* Animate color changes */
        }
        .streak-value:hover {
             color: var(--primary-dark);
        }

        .streak-label {
            color: var(--text-light);
            font-size: 0.9rem; /* Slightly larger label */
            font-weight: 500;
        }

        .stats-section {
            margin-top: 2.5rem;
            animation: fadeInUp 0.7s ease-out;
        }

        .stats-title {
            font-size: 1.5rem; /* Bigger title */
            margin-bottom: 1.5rem;
            color: var(--secondary); /* Blue title */
            text-align: center;
            font-weight: 700;
        }
        .stats-title::before { content: '🗓️ '; } /* Calendar emoji */

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.6rem; /* Slightly more gap */
            background-color: #fffafa; /* Light background for calendar area */
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff; /* White days */
            border-radius: 10px; /* Rounder days */
            font-size: 0.8rem;
            font-weight: 500;
            cursor: default;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day.has-completed {
            background-color: var(--success); /* Mint green */
            color: var(--text); /* Darker text for contrast */
            font-weight: 700;
            transform: scale(1.05); /* Pop effect */
            border-color: var(--success-dark);
        }
        /* Add a little star on completed days */
        .calendar-day.has-completed::after {
            content: '★';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.8);
        }


        .calendar-day.today {
            border: 2px solid var(--primary); /* Pink border for today */
            color: var(--primary);
            font-weight: 700;
        }
         .calendar-day:not(.has-completed):hover {
             background-color: #fff5f8; /* Very light pink hover */
             transform: scale(1.03);
         }

        /* --- Modal Styling --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 175, 204, 0.3); /* Pinkish overlay */
            backdrop-filter: blur(5px); /* Blur background */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card);
            padding: 2.5rem; /* More padding */
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px; /* Slightly smaller modal */
            transform: scale(0.95) translateY(-20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy transition */
            box-shadow: 0 10px 30px -5px rgba(255, 175, 204, 0.4); /* Stronger shadow */
             border: 2px solid var(--primary-light);
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px dashed var(--border); /* Dashed line separator */
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.6rem; /* Larger title */
            color: var(--primary);
            font-weight: 700;
        }
         .modal-title::before { content: '✏️ '; } /* Pencil emoji */

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            background-color: var(--text-light); /* Use text light color */
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--text);
        }

        /* --- Animations --- */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            80% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

         @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            h1 { font-size: 2rem; }
            .streak-section {
                flex-direction: column;
                gap: 1rem;
            }
            .streak-card { margin: 0; }
            .calendar { grid-template-columns: repeat(7, 1fr); gap: 0.4rem; padding: 0.8rem; } /* Keep 7 columns if possible */
             .calendar-day { font-size: 0.7rem; }
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.8rem; }
            .form-group { flex-direction: column; }
             input[type="text"] { font-size: 0.9rem;}
             button { font-size: 0.9rem; padding: 0.75rem 1.2rem;}
            .habit-item { padding: 0.8rem 1rem; flex-wrap: wrap; } /* Allow wrap on small screens */
            .habit-text { font-size: 0.95rem; margin-bottom: 0.5rem; /* Add space if actions wrap below */ width: 100%; order: 1; /* Ensure text is first */ }
            .habit-checkbox { margin-right: 0.8rem; order: 0;}
            .habit-actions { order: 2; margin-left: auto; /* Push actions to the right */ }
            .streak-value { font-size: 2rem; }
            .modal-content { padding: 1.5rem; }
            .modal-title { font-size: 1.4rem; }
            .calendar { gap: 0.3rem; padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>My Kawaii Habits</h1>
            <div class="date" id="current-date"></div>
        </header>

        <section class="streak-section">
            <div class="streak-card">
                <div class="streak-value" id="current-streak">0</div>
                <div class="streak-label">💖 Current Streak</div>
            </div>
            <div class="streak-card">
                <div class="streak-value" id="completion-rate">0%</div>
                <div class="streak-label">🌟 Completion Rate</div>
            </div>
            <div class="streak-card">
                <div class="streak-value" id="total-completed">0</div>
                <div class="streak-label">🎉 Total Completed</div>
            </div>
        </section>

        <div class="card">
            <div class="form-group">
                <input type="text" id="habit-input" placeholder="Add a cute new habit! ✨" autocomplete="off">
                <button id="add-habit-btn"><i class="fa-solid fa-plus"></i> Add!</button>
            </div>

            <div class="habit-list" id="habit-list">
                <!-- Habits will be added here -->
            </div>

            <div class="empty-state" id="empty-state" style="display: none;">
                 <p>No habits yet! Let's add something fun to track today! (ﾉ◕ヮ◕)ﾉ*:･ﾟ✧</p>
            </div>
        </div>

        <div class="card stats-section">
            <h2 class="stats-title">Your Lovely Progress (Last 28 Days)</h2>
            <div class="calendar" id="calendar">
                <!-- Calendar days will be added here -->
            </div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Habit</h2>
                <button class="modal-close" id="close-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="edit-habit-input" placeholder="New habit name...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-edit"><i class="fa-solid fa-xmark"></i> Cancel</button>
                <button id="save-edit"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
            </div>
        </div>
    </div>

    <script type="module"> // Use type="module" for async/await top-level
        // --- WARNING ---
        // This setup does NOT use user authentication or Row Level Security.
        // Anyone with your Supabase URL and Anon Key can read, add, edit,
        // and delete ALL habits and completions.
        // Only use this if you understand and accept the risks.
        // --- --- --- ---

        // --- Supabase Setup ---
        if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_ANON_KEY === 'undefined') {
            alert("⚠️ Supabase configuration not found! Make sure config.js is present and correct.");
            // You might want to disable the app further here
        }

        const supabaseUrl = SUPABASE_URL;
        const supabaseKey = SUPABASE_ANON_KEY;
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // --- DOM Elements ---
        const habitInput = document.getElementById('habit-input');
        const addHabitBtn = document.getElementById('add-habit-btn');
        const habitList = document.getElementById('habit-list');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');
        const currentDateElement = document.getElementById('current-date');
        const editModal = document.getElementById('edit-modal');
        const editHabitInput = document.getElementById('edit-habit-input');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const closeModalBtn = document.getElementById('close-modal');
        const currentStreakElement = document.getElementById('current-streak');
        const completionRateElement = document.getElementById('completion-rate');
        const totalCompletedElement = document.getElementById('total-completed');
        const calendarElement = document.getElementById('calendar');

        // --- App State ---
        let habits = []; // Stores { id, text, created_at } fetched from Supabase
        let completions = {}; // Stores { 'YYYY-MM-DD': [habitId1, habitId2], ... } fetched from Supabase
        let currentEditId = null;
        let today = ''; // YYYY-MM-DD format
        let isLoading = true;

        // --- Helper Functions ---
        function formatDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const todayDate = new Date();
            currentDateElement.textContent = todayDate.toLocaleDateString('en-US', options);
            return todayDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        }

        function setLoading(loading) {
            isLoading = loading;
            habitInput.disabled = loading;
            addHabitBtn.disabled = loading;
            if (loading) {
                loadingState.style.display = 'block';
                habitList.style.display = 'none';
                emptyState.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
                 // renderHabits will handle showing list or empty state
            }
        }

        // Basic HTML escaping function
         function escapeHTML(str) {
             const div = document.createElement('div');
             if (typeof str === 'string') {
                div.appendChild(document.createTextNode(str));
                return div.innerHTML;
             }
             return ''; // Return empty string if input is not a string
         }

        // --- Supabase Interaction Functions ---

        async function loadInitialData() {
            setLoading(true);
            try {
                // Fetch habits (no user filter needed)
                const { data: habitData, error: habitError } = await supabase
                    .from('habits')
                    .select('id, text, created_at')
                    .order('created_at', { ascending: true });

                if (habitError) throw habitError;
                habits = habitData || [];

                // Fetch completions (no user filter needed)
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);
                const startDateString = startDate.toISOString().split('T')[0];

                const { data: completionData, error: completionError } = await supabase
                    .from('completions')
                    .select('habit_id, completed_at')
                    .gte('completed_at', startDateString);

                if (completionError) throw completionError;

                // Process completions
                completions = {};
                (completionData || []).forEach(comp => {
                    const dateStr = comp.completed_at;
                    if (!completions[dateStr]) {
                        completions[dateStr] = [];
                    }
                    // Ensure no duplicates if DB constraint somehow failed or data is old
                    if (!completions[dateStr].includes(comp.habit_id)) {
                        completions[dateStr].push(comp.habit_id);
                    }
                });

                renderHabits();
                renderCalendar();
                updateStats();

            } catch (error) {
                console.error("Error loading data:", error.message);
                alert(`Oops! 🥺 Could not load data: ${error.message}`);
            } finally {
                setLoading(false);
            }
        }

        async function addHabit() {
            const text = habitInput.value.trim();
            if (text === '' || isLoading) return;

            setLoading(true);

            try {
                // Insert habit (no user_id)
                const { data, error } = await supabase
                    .from('habits')
                    .insert({ text: text })
                    .select()
                    .single();

                if (error) throw error;

                if (data) {
                    habits.push(data);
                    renderHabits();
                    updateStats();
                    renderCalendar();
                    habitInput.value = '';
                } else {
                     console.warn("Insert successful but no data returned.");
                }

            } catch (error) {
                console.error("Error adding habit:", error.message);
                alert(`Couldn't add habit: ${error.message} (｡•́︿•̀｡)`);
            } finally {
                 setLoading(false);
            }
        }

        async function toggleHabit(e) {
            const habitId = parseInt(e.target.getAttribute('data-id'));
            if (isNaN(habitId) || isLoading) return;

             const habitElement = e.target.closest('.habit-item');
             const isCurrentlyCompleted = habitElement.classList.contains('completed');

             // --- Optimistic UI Update ---
             habitElement.classList.toggle('completed');
             if (!completions[today]) completions[today] = [];
             const completedIndex = completions[today].indexOf(habitId);

             if (isCurrentlyCompleted) { // Removing completion
                 if (completedIndex > -1) completions[today].splice(completedIndex, 1);
             } else { // Adding completion
                 if (completedIndex === -1) completions[today].push(habitId);
             }
             updateStats();
             renderCalendar(); // Update calendar day style
             // --- End Optimistic Update ---


            try {
                if (isCurrentlyCompleted) {
                    // Delete completion record (no user_id)
                    const { error } = await supabase
                        .from('completions')
                        .delete()
                        .match({ habit_id: habitId, completed_at: today });
                    if (error) throw error;
                } else {
                    // Insert completion record (no user_id)
                    const { error } = await supabase
                        .from('completions')
                        .insert({ habit_id: habitId, completed_at: today });
                     // Handle potential unique constraint violation (user clicked twice fast)
                     if (error && error.code === '23505') { // Postgres code for unique violation
                         console.warn(`Completion for habit ${habitId} on ${today} already exists (ignored).`);
                         // No need to throw, the state is likely already correct due to optimistic update
                     } else if (error) {
                         throw error; // Throw other errors
                     }
                }
                 console.log(`Completion toggled successfully for habit ${habitId} on ${today}`);

            } catch (error) {
                console.error("Error toggling completion:", error.message);
                alert(`Couldn't update completion: ${error.message} Σ(°ロ°)`);

                 // --- Revert Optimistic Update on Error ---
                 habitElement.classList.toggle('completed'); // Toggle back
                 if (isCurrentlyCompleted) { // Add it back if removed
                      if (completedIndex === -1) completions[today].push(habitId);
                  } else { // Remove it if added
                      if (completedIndex > -1) completions[today].splice(completedIndex, 1);
                  }
                 updateStats();
                 renderCalendar();
                 // --- End Revert ---
            }
        }

        async function deleteHabit(e) {
             const button = e.target.closest('.delete-habit');
             if (!button || isLoading) return;

             const habitId = parseInt(button.getAttribute('data-id'));
             if (isNaN(habitId)) return;

             const habitText = habits.find(h => h.id === habitId)?.text || 'this habit';

             if (confirm(`Are you sure you want to delete "${habitText}"? (｡•́︿•̀｡)`)) {
                setLoading(true);
                try {
                    // Delete from Supabase (no user_id). Cascade delete should handle completions.
                    const { error } = await supabase
                        .from('habits')
                        .delete()
                        .match({ id: habitId });

                    if (error) throw error;

                    // Remove from local state
                    habits = habits.filter(habit => habit.id !== habitId);
                    Object.keys(completions).forEach(date => {
                        completions[date] = completions[date].filter(id => id !== habitId);
                    });

                    renderHabits();
                    updateStats();
                    renderCalendar();

                 } catch (error) {
                    console.error("Error deleting habit:", error.message);
                    alert(`Couldn't delete habit: ${error.message} (ಥ﹏ಥ)`);
                 } finally {
                    setLoading(false);
                 }
             }
        }

         async function saveEdit() {
            const text = editHabitInput.value.trim();
            if (text === '' || !currentEditId || isLoading) return;

            setLoading(true);
            try {
                // Update habit (no user_id)
                const { data, error } = await supabase
                    .from('habits')
                    .update({ text: text })
                    .match({ id: currentEditId })
                    .select()
                    .single();

                if (error) throw error;

                if (data) {
                    const habitIndex = habits.findIndex(h => h.id === currentEditId);
                    if (habitIndex !== -1) {
                        habits[habitIndex] = data;
                    }
                    renderHabits();
                }
                 closeModal();

            } catch (error) {
                console.error("Error updating habit:", error.message);
                alert(`Couldn't save changes: ${error.message} (ノಠ益ಠ)ノ彡┻━┻`);
            } finally {
                 setLoading(false);
            }
        }

        // --- Rendering Functions (mostly unchanged, ensure escapeHTML is used) ---
        function renderHabits() {
            if (isLoading) return;

            if (habits.length === 0) {
                emptyState.style.display = 'block';
                habitList.style.display = 'none';
                habitList.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                habitList.style.display = 'flex';
                habitList.innerHTML = '';

                const todayCompletions = completions[today] || [];

                habits.forEach((habit, index) => {
                    const isCompleted = todayCompletions.includes(habit.id);
                    const habitElement = document.createElement('div');
                    habitElement.className = `habit-item ${isCompleted ? 'completed' : ''}`;

                    habitElement.innerHTML = `
                        <div class="habit-checkbox" data-id="${habit.id}" role="checkbox" aria-checked="${isCompleted}"></div>
                        <div class="habit-text">${escapeHTML(habit.text)}</div>
                        <div class="habit-actions">
                            <button class="btn-small edit-habit" data-id="${habit.id}" title="Edit Habit"><i class="fa-solid fa-pencil"></i></button>
                            <button class="btn-small btn-danger delete-habit" data-id="${habit.id}" title="Delete Habit"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    `;
                    habitList.appendChild(habitElement);
                });
            }
             attachHabitListeners();
        }

         function attachHabitListeners() {
             document.querySelectorAll('.habit-checkbox').forEach(checkbox => {
                 checkbox.removeEventListener('click', toggleHabit); // Prevent duplicates
                 checkbox.addEventListener('click', toggleHabit);
             });
             document.querySelectorAll('.edit-habit').forEach(button => {
                  button.removeEventListener('click', showEditModal);
                 button.addEventListener('click', showEditModal);
             });
             document.querySelectorAll('.delete-habit').forEach(button => {
                  button.removeEventListener('click', deleteHabit);
                  button.addEventListener('click', deleteHabit);
             });
         }

        function renderCalendar() {
             if (isLoading) {
                  calendarElement.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 1rem;">Loading calendar...</div>';
                  return;
             }
            calendarElement.innerHTML = '';
            const days = [];
            const todayDate = new Date();
            const todayStr = todayDate.toISOString().split('T')[0];

            for (let i = 27; i >= 0; i--) {
                const date = new Date();
                date.setDate(todayDate.getDate() - i);
                days.push(date);
            }

            days.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                const dayOfMonth = date.getDate();

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = dayOfMonth;

                const relevantHabitsForDate = habits.filter(habit => {
                    const habitCreationDate = new Date(habit.created_at);
                    return habitCreationDate.setHours(0,0,0,0) <= date.setHours(0,0,0,0);
                });

                const completedOnDate = completions[dateStr] || [];
                const anyCompleted = relevantHabitsForDate.some(habit => completedOnDate.includes(habit.id));

                 if (anyCompleted) {
                    dayElement.classList.add('has-completed');
                     const completedNames = relevantHabitsForDate
                         .filter(h => completedOnDate.includes(h.id))
                         .map(h => h.text);
                     if (completedNames.length > 0) {
                         dayElement.title = `Completed: ${escapeHTML(completedNames.join(', '))}`;
                     }
                 }

                if (dateStr === todayStr) {
                    dayElement.classList.add('today');
                }

                calendarElement.appendChild(dayElement);
            });
        }

        // --- Calculation Functions (logic is unchanged, relies on local state) ---
        function calculateStreak() {
            let streak = 0;
            let currentDate = new Date();

            while (true) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const relevantHabits = habits.filter(habit => new Date(habit.created_at).setHours(0,0,0,0) <= currentDate.setHours(0,0,0,0));

                if (relevantHabits.length === 0) {
                      if (streak > 0) break;
                       break;
                }

                const completedOnDate = completions[dateStr] || [];
                const allRelevantCompleted = relevantHabits.every(habit => completedOnDate.includes(habit.id));

                if (allRelevantCompleted) {
                    streak++;
                } else {
                    if (dateStr !== today) {
                        break;
                    } else {
                        streak = 0;
                        break;
                    }
                }
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return streak;
        }

        function calculateCompletionRate() {
            if (habits.length === 0) return 0;

            let totalCompleted = 0;
            let totalPossible = 0;
            const historyDates = Object.keys(completions); // Dates with completion data

            // Iterate all dates since the *first* habit was created for a potentially more accurate rate
            const firstHabitDate = habits.length > 0
                ? new Date(Math.min(...habits.map(h => new Date(h.created_at).getTime())))
                : new Date();
            firstHabitDate.setHours(0, 0, 0, 0);

            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            const todayDateOnly = new Date(today).setHours(0,0,0,0); // Use today's date string for comparison

            while (currentDate >= firstHabitDate && currentDate <= todayDateOnly) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const completedOnDate = completions[dateStr] || [];

                habits.forEach(habit => {
                    // Only count if the habit existed on that date
                    if (new Date(habit.created_at).setHours(0,0,0,0) <= currentDate.getTime()) {
                        totalPossible++;
                        if (completedOnDate.includes(habit.id)) {
                            totalCompleted++;
                        }
                    }
                });

                // Move to the previous day
                currentDate.setDate(currentDate.getDate() - 1);
            }


            return totalPossible === 0 ? 0 : Math.round((totalCompleted / totalPossible) * 100);
        }

        function calculateTotalCompleted() {
            let total = 0;
            Object.values(completions).forEach(dayCompletions => {
                total += dayCompletions.length;
            });
            return total;
        }

        // --- Update Stats Display ---
        function updateStats() {
             if (isLoading) {
                 currentStreakElement.textContent = '-';
                 completionRateElement.textContent = '-';
                 totalCompletedElement.textContent = '-';
                 return;
             }
            const streak = calculateStreak();
            const completionRate = calculateCompletionRate(); // Use updated calc
            const totalCompleted = calculateTotalCompleted();

            currentStreakElement.textContent = streak;
            completionRateElement.textContent = `${completionRate}%`;
            totalCompletedElement.textContent = totalCompleted;
        }


        // --- Modal Functions ---
        function showEditModal(e) {
            const button = e.target.closest('.edit-habit');
             if (!button || isLoading) return;

            const habitId = parseInt(button.getAttribute('data-id'));
            const habit = habits.find(h => h.id === habitId);

            if (habit) {
                currentEditId = habitId;
                editHabitInput.value = habit.text;
                editModal.classList.add('show');
                editHabitInput.focus();
            }
        }

        function closeModal() {
            editModal.classList.remove('show');
            currentEditId = null;
            editHabitInput.value = '';
        }


        // --- Event Listeners ---
        addHabitBtn.addEventListener('click', addHabit);
        habitInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') addHabit();
        });

        saveEditBtn.addEventListener('click', saveEdit);
        editHabitInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') saveEdit();
        });
        cancelEditBtn.addEventListener('click', closeModal);
        closeModalBtn.addEventListener('click', closeModal);

        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) closeModal();
        });


        // --- Initial Load ---
        async function initializeApp() {
            console.log("⚠️ App running without user authentication. Data is public.");
            today = formatDate();
            await loadInitialData();
            attachHabitListeners(); // Ensure listeners are attached after initial load
        }

        initializeApp(); // Start the app

    </script>
</body>
</html>